= Implicit Provisioning

This document describes the current support for implicit provisioning in Aktualizr and https://github.com/advancedtelematic/meta-updater[meta-updater].

== Background

In automatic provisioning, bootstrap credentials are downloaded and installed on devices to initiate the provisioning process. In implicit provisioning, devices shall be pre-loaded with the requisite provisioning credentials signed by a root CA certificate which shall be uploaded to the server. The server will thus be able to authenticate a client device by verifying that the client's certificate was signed by the uploaded root CA.

== Configuration

The following items are relevant for implicit provisioning:

[options=header]
|===================
| Configuration option         | Where it will come from/what it does
| Server URL                   | Read from credentials archive
| Server Root CA cert          | Read from credentials archive
| Fleet Root CA cert           | Chain of trust for a device fleet; provided by the user. Must be uploaded by user to the server.
| Fleet Root CA private key    | Key for signing device certs in the fleet; provided by user, but used only for signing. Not stored on device.
| TLS device cert              | Pre-installed or manually installed; must be signed by Fleet Root CA private key
| TLS device key               | Pre-installed or manually installed
| Device ID                    | Read from Common Name field of TLS device cert
| Uptane public/private key    | Automatically generated by Aktualizr
| Uptane primary serial number | Automatically generated by Aktualizr
| Primary ECU Hardware ID      | Automatically generated by Aktualizr
|===================

An example `.toml` configuration file can be found at link:../config/sota_implicit_prov_ca.toml[]. This is what is used during bitbaking with meta-updater.

== Steps

1. Generate a root CA private key and self-signed certificate.
1. Upload the root CA certificate to the server.
1. In meta-updater, set `SOTA_CLIENT_PROV = "aktualizr-implicit-ca-prov"` and `SOTA_DEPLOY_CREDENTIALS = "0"`. Currently, you will also need to set `SOTA_PACKED_CREDENTIALS` to a provisioning credentials zip file.
1. Build a standard image using bitbake.
1. Boot the image.
1. Sign the client device certificate with the root private key and install it on the client device.
1. The server shall provide its own internal root CA certificate to client device.
1. The server shall authenticate the client device by verifying that the client's certificate was signed by the your root CA private key. (The server uses the root CA certificate that it was given in step 2 to do so.)
1. The client device authenticates the server by verifying that the server's certificate was signed by the server's internal root CA private key. (The client device uses the server's internal root CA certificate that it was given in step 7 to do so.)

== Simulated implicit provisioning with `cert_provider`

Implicit provisioning can be simulated with `cert_provider` without need for the user to create a root CA. `cert_provider` can use the existing autoprovisioning mechanisms to pre-install a certificate and key on the device.

1. In meta-updater, set `SOTA_CLIENT_PROV = "aktualizr-implicit-ca-prov"`. Currently, you will also need to set `SOTA_PACKED_CREDENTIALS` to provisioning credentials zip file.
1. Build a standard image using bitbake.
1. Boot the image.
1. Optionally, verify that Aktualizr has not provisioned and that the device is not known to the server.
1. Load credentials onto the device, for example with `cert_provider` from the Aktualizr repo: `cert_provider -c credentials.zip -t <device> -d /var/sota -r -u`
1. Verify that Aktualizr provisions correctly with the server using the expected Device ID.

== Credentials format

The provisioning credentials zip file format is specified in link:credentials.adoc[]. However, the only files in the archive used by `cert_provider` are `autoprov.url` and `autoprov_credentials.p12`. Note that `treehub.json` is required by `garage-sign`, and offline signing may require additional files.
